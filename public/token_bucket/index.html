<!DOCTYPE html>
<html lang="en">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-G300HG9GRT"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());

            gtag('config', 'G-G300HG9GRT');
        </script>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Algorithms 1: Token Bucket - lmbf</title><meta name="Description" content="This is my cool site"><meta property="og:url" content="http://localhost:1313/token_bucket/">
  <meta property="og:site_name" content="lmbf">
  <meta property="og:title" content="Algorithms 1: Token Bucket">
  <meta property="og:description" content="The token bucket falls into a class of algorithms usually known as rate-limiting algorithms, since they allow a server to process requests at a controlled rate. The way this algorithm works is fairly simple:
We have a bucket that holds a maximum number of tokens and each token represents permission to perform a request; Tokens are added to the bucket at a constant rate; When a client wants to make a request, they need to take a token from the bucket. If there are no tokens available, the request will be rejected. If there are tokens available, the number of tokens is updated and the client’s request goes through the remainder of the system. There are a few considerations when implementing this:">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-04-19T13:46:12+01:00">
    <meta property="article:modified_time" content="2025-04-19T13:46:12+01:00">
    <meta property="og:image" content="http://localhost:1313/logo.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://localhost:1313/logo.png">
  <meta name="twitter:title" content="Algorithms 1: Token Bucket">
  <meta name="twitter:description" content="The token bucket falls into a class of algorithms usually known as rate-limiting algorithms, since they allow a server to process requests at a controlled rate. The way this algorithm works is fairly simple:
We have a bucket that holds a maximum number of tokens and each token represents permission to perform a request; Tokens are added to the bucket at a constant rate; When a client wants to make a request, they need to take a token from the bucket. If there are no tokens available, the request will be rejected. If there are tokens available, the number of tokens is updated and the client’s request goes through the remainder of the system. There are a few considerations when implementing this:">
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://localhost:1313/token_bucket/" /><link rel="prev" href="http://localhost:1313/remove_dups/" /><link rel="next" href="http://localhost:1313/records_and_pages_in_disk/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Algorithms 1: Token Bucket",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/localhost:1313\/token_bucket\/"
        },"genre": "posts","wordcount":  555 ,
        "url": "http:\/\/localhost:1313\/token_bucket\/","datePublished": "2025-04-19T13:46:12+01:00","dateModified": "2025-04-19T13:46:12+01:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Lmbf"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="auto" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="lmbf">Lmbf</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="lmbf">Lmbf</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Algorithms 1: Token Bucket</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Lmbf</a>
</span>&nbsp;<span class="post-category">included in <a href="/categories/algorithms/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Algorithms</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2025-04-19">2025-04-19</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;555 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;3 minutes&nbsp;</div>
        </div><div class="content" id="content"><p>The token bucket falls into a class of algorithms usually known as rate-limiting algorithms, since they allow a server to process requests at a controlled rate. The way this algorithm works is fairly simple:</p>
<ul>
<li>We have a bucket that holds a maximum number of tokens and each token represents permission to perform a request;</li>
<li>Tokens are added to the bucket at a constant rate;</li>
<li>When a client wants to make a request, they need to take a token from the bucket. If there are no tokens available, the request will be rejected. If there are tokens available, the number of tokens is updated and the client&rsquo;s request goes through the remainder of the system.</li>
</ul>
<p>There are a few considerations when implementing this:</p>
<ol>
<li>How many tokens does each request consume</li>
<li>How do we store the current number of tokens</li>
<li>How do we handle concurrent requests</li>
<li>What rate do we want our bucket to fill</li>
<li>How many tokens should the bucket hold</li>
<li>How do we want to handle traffic spikes</li>
</ol>
<p>For simplicity, let us assume that the answer to <code>1.</code> is a single token per request.</p>
<p>As for <code>2.</code>, we have to consider our options. If our token bucket is simply storing the number of available tokens at a given time, then the bucket has to be filled asynchronously. But if the bucket is filled asynchronously, then each incoming request has to place a lock on the number of available tokens, and so much the bucket filling process. For fast filling buckets, this leads to lock contention, which will ultimately result in not being able to process requests at an appropriate speed. For this reason, it is preferable to store the number of tokens available as well as the timestamp of the previous request.</p>
<p>While we can take up the task of handling concurrency ourselves, it is usually better to let dedicated systems handle this task. A classical relational database such as Postgres might not be the best option since disk accesses/writes would result in considerable added latency to each request. As such an in-memory cache is a more suitable option due to its speed and time-based expiration strategy support (Redis is a popular choice for this).</p>
<p>Questions <code>4</code> and <code>5</code> can be answered in tandem. It all depends on what business logic are we attempting to rate limit. If we are refering to login attempts, we might want the bucket to have a slow refill rate (on the magnitude of minutes) with a fairly low maximum bucket capacity per user. On the other hand, we if are applying this to an API that handles thousands of requests per second, we will require a much faster refill rate, and possibly different limits and refill rates depending on the type of user (<em>i.e.</em>, free user <em>vs.</em> premium user).</p>
<p>Last but not least, we have to make a consideration on how we want to handle traffic spikes. My personal preference here is to let the token bucket handle traffic as is but also set up a metric for the amount of rejected requests. This metric would then have an alert associated and a way to perform a manual override to the bucket refill rate, in case the surge in traffic we are witnessing is legitimate traffic (<em>e.g.</em>, Black Friday traffic spike). But that&rsquo;s more of a system design question.</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2025-04-19</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/remove_dups/" class="prev" rel="prev" title="Leetcode 12: Remove duplicates"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Leetcode 12: Remove duplicates</a>
            <a href="/records_and_pages_in_disk/" class="next" rel="next" title="High-level view of storing data in a database">High-level view of storing data in a database<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2023 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":200},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
